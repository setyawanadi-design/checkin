<!DOCTYPE html>
<html>
<head>
<script src="https://apis.google.com/js/api.js"></script>
  <title>Surveyor App</title>
</head>
<body>

  <h1>ðŸ“‹ Surveyor Check-In</h1>

  <form id="checkInForm">
    <label>Name:</label><br>
    <input type="text" id="name" required><br><br>

    <label>Notes:</label><br>
    <input type="text" id="notes"><br><br>

    <button type="submit">Check In</button>
  </form>

<h2>Today's Check-Ins</h2>

<table border="1" id="checkInTable">
<thead>
  <tr>
    <th>Name</th>
    <th>Notes</th>
    <th>Time</th>
    <th>Location</th>
  </tr>
</thead>

  <tbody>
    <!-- New rows will go here -->
  </tbody>
</table>

<script>
  const CLIENT_ID = '452071405201-qd5dajju29v0mggmsqo2j0iov4f6audg.apps.googleusercontent.com';
  const API_KEY = 'AIzaSyBOV8cDq7fceHCigFuoCevPwRN9pG6riyI';
  const SHEET_ID = '1t0eXpsVfZL2ZEyc8N35pzrR7xQINkkhUvRekYki46bo';

  function initGoogleAPI() {
    gapi.client.init({
      apiKey: API_KEY,
      clientId: CLIENT_ID,
      scope: 'https://www.googleapis.com/auth/spreadsheets',
      discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"],
    }).then(function () {
      console.log('Google API initialized!');
    });
  }

  gapi.load('client:auth2', initGoogleAPI);

  const form = document.getElementById('checkInForm');
  const table = document.getElementById('checkInTable').getElementsByTagName('tbody')[0];

  form.addEventListener('submit', function(event) {
    event.preventDefault();

    const name = document.getElementById('name').value;
    const notes = document.getElementById('notes').value;
    const now = new Date();
    const timeString = now.toLocaleString(); // Full timestamp

    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(function(position) {
        const latitude = position.coords.latitude;
        const longitude = position.coords.longitude;
        const location = `Lat: ${latitude}, Lon: ${longitude}`;

        // Add to table
        const newRow = table.insertRow();
        newRow.insertCell(0).textContent = name;
        newRow.insertCell(1).textContent = notes;
        newRow.insertCell(2).textContent = timeString;
        newRow.insertCell(3).textContent = location;

        // SEND TO GOOGLE SHEETS
        sendToGoogleSheets(name, notes, timeString, location);

        form.reset();
      }, function() {
        alert("Location access denied. Can't check-in.");
      });
    } else {
      alert("Geolocation is not supported by this browser.");
    }
  });

  function sendToGoogleSheets(name, notes, timeString, location) {
    const params = {
      spreadsheetId: SHEET_ID,
      range: "Sheet1!A:D",
      valueInputOption: "USER_ENTERED",
      insertDataOption: "INSERT_ROWS",
      resource: {
        values: [
          [name, notes, timeString, location]
        ]
      }
    };

    gapi.client.sheets.spreadsheets.values.append(params)
      .then((response) => {
        console.log("Success!", response);
      }, (error) => {
        console.error("Error", error);
        alert("Failed to submit to Google Sheets");
      });
  }
</script>

</body>
</html>
